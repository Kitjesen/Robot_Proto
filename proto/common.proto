// common.proto
// 共享类型定义 - 所有服务共用
// 版本: 1.0.0
// 约束: 字段编号一旦发布永不变更

syntax = "proto3";

package robot.v1;

import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";

// ==================== 基础类型 ====================

// 向量3D
message Vector3 {
  double x = 1;
  double y = 2;
  double z = 3;
}

// 四元数
message Quaternion {
  double x = 1;
  double y = 2;
  double z = 3;
  double w = 4;
}

// 位姿（位置 + 姿态）
message Pose {
  Vector3 position = 1;
  Quaternion orientation = 2;
}

// 速度（线速度 + 角速度）
message Twist {
  Vector3 linear = 1;   // m/s
  Vector3 angular = 2;  // rad/s
}

// 标准消息头
message Header {
  google.protobuf.Timestamp timestamp = 1;
  string frame_id = 2;
  uint64 sequence = 3;
}

// ==================== 请求/响应基础 ====================

// 幂等请求基类
message RequestBase {
  // 客户端生成的唯一请求 ID（UUID v4）
  // 幂等性保证: 服务端缓存最近 60s 的请求结果
  string request_id = 1;
  google.protobuf.Timestamp client_timestamp = 2;
  google.protobuf.Duration timeout = 3;
}

// 响应基类
message ResponseBase {
  string request_id = 1;
  google.protobuf.Timestamp server_timestamp = 2;
  google.protobuf.Duration processing_time = 3;
  ErrorCode error_code = 4;
  string error_message = 5;
}

// 错误码
enum ErrorCode {
  ERROR_CODE_UNSPECIFIED = 0;
  ERROR_CODE_OK = 1;
  ERROR_CODE_INVALID_REQUEST = 2;
  ERROR_CODE_UNAUTHORIZED = 3;
  ERROR_CODE_FORBIDDEN = 4;
  ERROR_CODE_RESOURCE_NOT_FOUND = 5;
  ERROR_CODE_RESOURCE_CONFLICT = 6;
  ERROR_CODE_SERVICE_UNAVAILABLE = 7;
  ERROR_CODE_INTERNAL_ERROR = 8;
  ERROR_CODE_TIMEOUT = 9;
  ERROR_CODE_RATE_LIMITED = 10;
  
  // ControlService 错误
  ERROR_CODE_LEASE_REQUIRED = 2000;
  ERROR_CODE_LEASE_CONFLICT = 2001;
  ERROR_CODE_LEASE_EXPIRED = 2002;
  ERROR_CODE_SAFETY_STOP = 2003;
  ERROR_CODE_MODE_CONFLICT = 2004;
}

// ==================== 用户与权限 ====================

enum UserRole {
  USER_ROLE_UNSPECIFIED = 0;
  USER_ROLE_VIEWER = 1;
  USER_ROLE_OPERATOR = 2;
  USER_ROLE_ADMIN = 3;
}

// ==================== 租约 ====================

message OperatorLease {
  string lease_token = 1;
  string holder_id = 2;
  google.protobuf.Timestamp issued_at = 3;
  google.protobuf.Timestamp expires_at = 4;
  google.protobuf.Duration ttl = 5;
}

// ==================== 事件 ====================

enum EventType {
  EVENT_TYPE_UNSPECIFIED = 0;
  EVENT_TYPE_SYSTEM_BOOT = 1;
  EVENT_TYPE_SYSTEM_SHUTDOWN = 2;
  EVENT_TYPE_MODE_CHANGE = 3;
  EVENT_TYPE_NAV_GOAL_REACHED = 10;
  EVENT_TYPE_NAV_GOAL_FAILED = 11;
  EVENT_TYPE_NAV_PATH_BLOCKED = 12;
  EVENT_TYPE_SAFETY_ESTOP = 20;
  EVENT_TYPE_SAFETY_COLLISION_WARNING = 21;
  EVENT_TYPE_SAFETY_TILT_WARNING = 22;
  EVENT_TYPE_SENSOR_LIDAR_FAIL = 30;
  EVENT_TYPE_SENSOR_IMU_FAIL = 31;
  EVENT_TYPE_SENSOR_CAMERA_FAIL = 32;
  EVENT_TYPE_LOCALIZATION_LOST = 33;
  EVENT_TYPE_TASK_STARTED = 40;
  EVENT_TYPE_TASK_COMPLETED = 41;
  EVENT_TYPE_TASK_FAILED = 42;
  EVENT_TYPE_NETWORK_DISCONNECTED = 50;
  EVENT_TYPE_NETWORK_RECONNECTED = 51;
}

enum EventSeverity {
  EVENT_SEVERITY_UNSPECIFIED = 0;
  EVENT_SEVERITY_DEBUG = 1;
  EVENT_SEVERITY_INFO = 2;
  EVENT_SEVERITY_WARNING = 3;
  EVENT_SEVERITY_ERROR = 4;
  EVENT_SEVERITY_CRITICAL = 5;
}

// 事件定义 - 带回放能力
message Event {
  string event_id = 1;  // 严格递增（ULID）
  EventType type = 2;
  EventSeverity severity = 3;
  string title = 4;
  string description = 5;
  google.protobuf.Timestamp timestamp = 6;
  Pose robot_pose = 7;
  string related_task_id = 8;
  bytes snapshot = 9;
  string metadata_json = 10;
}

// ==================== 资源 ====================

enum ResourceType {
  RESOURCE_TYPE_UNSPECIFIED = 0;
  RESOURCE_TYPE_CAMERA = 1;
  RESOURCE_TYPE_POINTCLOUD = 2;
  RESOURCE_TYPE_MAP = 3;
  RESOURCE_TYPE_STATE = 4;
  RESOURCE_TYPE_EVENT = 5;
}

message ResourceId {
  ResourceType type = 1;
  string name = 2;
}

enum CompressionType {
  COMPRESSION_TYPE_UNSPECIFIED = 0;
  COMPRESSION_TYPE_NONE = 1;
  COMPRESSION_TYPE_LZ4 = 2;
  COMPRESSION_TYPE_ZSTD = 3;
}

// ==================== 任务 ====================

enum TaskType {
  TASK_TYPE_UNSPECIFIED = 0;
  TASK_TYPE_NAVIGATION = 1;
  TASK_TYPE_MAPPING = 2;
  TASK_TYPE_INSPECTION = 3;
  TASK_TYPE_RETURN_HOME = 4;
  TASK_TYPE_FOLLOW_PATH = 5;
}

enum TaskStatus {
  TASK_STATUS_UNSPECIFIED = 0;
  TASK_STATUS_PENDING = 1;
  TASK_STATUS_RUNNING = 2;
  TASK_STATUS_PAUSED = 3;
  TASK_STATUS_COMPLETED = 4;
  TASK_STATUS_FAILED = 5;
  TASK_STATUS_CANCELLED = 6;
}

message Task {
  string task_id = 1;
  TaskType type = 2;
  TaskStatus status = 3;
  string params_json = 4;
  google.protobuf.Timestamp created_at = 5;
  google.protobuf.Timestamp started_at = 6;
  google.protobuf.Timestamp ended_at = 7;
  float progress_percent = 8;
  string failure_reason = 9;
}

// ==================== 网络质量 ====================

message ConnectionQuality {
  double rtt_ms = 1;
  double packet_loss = 2;
  double jitter_ms = 3;
  uint32 bandwidth_kbps = 4;
  int32 signal_strength = 5;
}
