// control.proto
// ControlService - 租约、模式、急停、任务、遥操作
// 版本: 1.0.0

syntax = "proto3";

package robot.v1;

import "common.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";

// ControlService - 控制机器人行为
service ControlService {
  // 租约管理
  rpc AcquireLease(AcquireLeaseRequest) returns (AcquireLeaseResponse);
  rpc RenewLease(RenewLeaseRequest) returns (RenewLeaseResponse);
  rpc ReleaseLease(ReleaseLeaseRequest) returns (ReleaseLeaseResponse);
  
  // 模式切换
  rpc SetMode(SetModeRequest) returns (SetModeResponse);
  
  // 急停
  rpc EmergencyStop(EmergencyStopRequest) returns (EmergencyStopResponse);
  
  // 遥操作流（双向流，需 lease）
  rpc StreamTeleop(stream TeleopCommand) returns (stream TeleopFeedback);
  
  // 任务控制
  rpc StartTask(StartTaskRequest) returns (StartTaskResponse);
  rpc CancelTask(CancelTaskRequest) returns (CancelTaskResponse);
  rpc PauseTask(PauseTaskRequest) returns (PauseTaskResponse);
  rpc ResumeTask(ResumeTaskRequest) returns (ResumeTaskResponse);
  rpc GetTaskStatus(GetTaskStatusRequest) returns (GetTaskStatusResponse);
}

// ==================== 租约 ====================

message AcquireLeaseRequest {
  RequestBase base = 1;
}

message AcquireLeaseResponse {
  ResponseBase base = 1;
  OperatorLease lease = 2;
}

message RenewLeaseRequest {
  RequestBase base = 1;
  string lease_token = 2;
}

message RenewLeaseResponse {
  ResponseBase base = 1;
  OperatorLease lease = 2;
}

message ReleaseLeaseRequest {
  RequestBase base = 1;
  string lease_token = 2;
}

message ReleaseLeaseResponse {
  ResponseBase base = 1;
}

// ==================== 模式切换 ====================

enum RobotMode {
  ROBOT_MODE_UNSPECIFIED = 0;
  ROBOT_MODE_IDLE = 1;          // 空闲
  ROBOT_MODE_MANUAL = 2;        // 手动（手柄）
  ROBOT_MODE_TELEOP = 3;        // 遥操作（远程）
  ROBOT_MODE_AUTONOMOUS = 4;    // 自主导航
  ROBOT_MODE_MAPPING = 5;       // 建图模式
  ROBOT_MODE_ESTOP = 6;         // 急停状态
}

message SetModeRequest {
  RequestBase base = 1;
  RobotMode mode = 2;
}

message SetModeResponse {
  ResponseBase base = 1;
  RobotMode current_mode = 2;
}

// ==================== 急停 ====================

message EmergencyStopRequest {
  RequestBase base = 1;
  // 是否硬急停（需要手动复位）
  bool hard_stop = 2;
}

message EmergencyStopResponse {
  ResponseBase base = 1;
  bool stopped = 2;
}

// ==================== 遥操作 ====================

// 遥操作命令（客户端 → 服务端）
// 硬约束: 必须携带有效 lease_token，否则拒绝
message TeleopCommand {
  // 租约令牌
  string lease_token = 1;
  
  // 客户端时间戳（用于延迟计算）
  google.protobuf.Timestamp timestamp = 2;
  
  // 序列号（单调递增，检测丢包）
  uint64 sequence = 3;
  
  // 目标速度
  Twist target_velocity = 4;
  
  // 是否启用避障
  bool enable_obstacle_avoidance = 5;
}

// 遥操作反馈（服务端 → 客户端）
message TeleopFeedback {
  google.protobuf.Timestamp timestamp = 1;
  uint64 command_sequence = 2;  // 对应的命令序号
  
  // 实际执行的速度（经 Safety Gate 限幅后）
  Twist actual_velocity = 3;
  
  // 限幅原因
  repeated string limit_reasons = 4;
  
  // 当前安全状态
  SafetyStatus safety_status = 5;
  
  // 控制延迟（从客户端发送到实际执行）
  google.protobuf.Duration control_latency = 6;
}

message SafetyStatus {
  bool estop_active = 1;
  bool deadman_active = 2;
  bool tilt_limit_active = 3;
  bool speed_limited = 4;
  double max_allowed_speed = 5;  // m/s
  string safety_message = 6;
}

// ==================== 导航/建图参数 ====================

// 导航目标点
message NavigationGoal {
  Vector3 position = 1;          // 目标位置 (x, y, z) odom 坐标系
  double yaw = 2;                // 目标朝向 (rad), 0 = 不指定
  string label = 3;              // 航点标签（可选）
  double arrival_radius = 4;     // 到达半径 (m), 默认 1.0
}

// 导航任务参数
message NavigationParams {
  repeated NavigationGoal waypoints = 1;  // 航点列表
  bool loop = 2;                          // 是否循环
  double max_speed = 3;                   // 最大速度限制 (m/s), 0 = 不限
}

// 建图任务参数
message MappingParams {
  string map_name = 1;            // 地图名称（保存时使用）
  bool save_on_complete = 2;      // 完成后自动保存
  double resolution = 3;          // 分辨率 (m), 默认 0.1
}

// 路径跟随参数
message FollowPathParams {
  repeated NavigationGoal waypoints = 1;
  double tracking_tolerance = 2;  // 跟踪容差 (m)
}

// ==================== 任务控制 ====================

message StartTaskRequest {
  RequestBase base = 1;
  TaskType task_type = 2;
  string params_json = 3;                  // 向后兼容的 JSON 参数
  // 结构化参数（优先级高于 params_json）
  NavigationParams navigation_params = 4;
  MappingParams mapping_params = 5;
  FollowPathParams follow_path_params = 6;
}

message StartTaskResponse {
  ResponseBase base = 1;
  string task_id = 2;
  Task task = 3;
}

message CancelTaskRequest {
  RequestBase base = 1;
  string task_id = 2;
}

message CancelTaskResponse {
  ResponseBase base = 1;
  Task task = 2;
}

message PauseTaskRequest {
  RequestBase base = 1;
  string task_id = 2;
}

message PauseTaskResponse {
  ResponseBase base = 1;
  Task task = 2;
}

message ResumeTaskRequest {
  RequestBase base = 1;
  string task_id = 2;
}

message ResumeTaskResponse {
  ResponseBase base = 1;
  Task task = 2;
}

message GetTaskStatusRequest {
  RequestBase base = 1;
  string task_id = 2;
}

message GetTaskStatusResponse {
  ResponseBase base = 1;
  Task task = 2;
}
