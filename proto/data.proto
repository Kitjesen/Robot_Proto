// data.proto
// DataService - 点云、地图、文件、视频控制
// 版本: 1.0.0

syntax = "proto3";

package robot.v1;

import "common.proto";
import "google/protobuf/empty.proto";

// DataService - 数据资源订阅与下载
service DataService {
  // 列出可用资源
  rpc ListResources(google.protobuf.Empty) returns (ListResourcesResponse);
  
  // 订阅资源流（点云/地图）
  rpc Subscribe(SubscribeRequest) returns (stream DataChunk);
  
  // 取消订阅
  rpc Unsubscribe(UnsubscribeRequest) returns (UnsubscribeResponse);
  
  // 文件下载（分块）
  rpc DownloadFile(DownloadFileRequest) returns (stream FileChunk);
  
  // 视频控制（WebRTC 信令）- 旧接口，保留兼容
  rpc StartCamera(StartCameraRequest) returns (StartCameraResponse);
  rpc StopCamera(StopCameraRequest) returns (StopCameraResponse);
  
  // WebRTC 双向信令流（新接口，支持实时视频/音频）
  rpc WebRTCSignaling(stream WebRTCSignal) returns (stream WebRTCSignal);
}

// ==================== 资源列举 ====================

message ListResourcesResponse {
  ResponseBase base = 1;
  repeated ResourceInfo resources = 2;
}

message ResourceInfo {
  ResourceId id = 1;
  string description = 2;
  bool available = 3;
  repeated ProfileOption profiles = 4;
}

message ProfileOption {
  string profile_name = 1;  // "low", "medium", "high"
  double frequency = 2;
  CompressionType compression = 3;
  uint32 max_bitrate_kbps = 4;
}

// ==================== 订阅 ====================

message SubscribeRequest {
  RequestBase base = 1;
  ResourceId resource_id = 2;
  SubscribeProfile profile = 3;
}

// 订阅配置（预算约束）
message SubscribeProfile {
  double frequency = 1;
  CompressionType compression = 2;
  
  // 点云专用
  uint32 max_points_per_frame = 3;
  uint32 max_bitrate_kbps = 4;
  
  // ROI（感兴趣区域，可选）
  BoundingBox roi = 5;
}

message BoundingBox {
  Vector3 min = 1;
  Vector3 max = 2;
}

message DataChunk {
  Header header = 1;
  ResourceId resource_id = 2;
  bytes data = 3;  // 压缩后的二进制
  CompressionType compression = 4;
  uint32 uncompressed_size = 5;
}

message UnsubscribeRequest {
  RequestBase base = 1;
  string subscription_id = 2;
}

message UnsubscribeResponse {
  ResponseBase base = 1;
}

// ==================== 文件下载 ====================

message DownloadFileRequest {
  RequestBase base = 1;
  string file_path = 2;  // 如: "/maps/building.pcd"
  uint32 chunk_size = 3; // 每块大小（bytes，默认 64KB）
}

message FileChunk {
  uint64 offset = 1;
  bytes data = 2;
  uint64 total_size = 3;
  bool is_last = 4;
}

// ==================== 视频控制 ====================

message StartCameraRequest {
  RequestBase base = 1;
  string camera_id = 2;  // "front", "rear"
  VideoProfile profile = 3;
}

message VideoProfile {
  uint32 width = 1;
  uint32 height = 2;
  uint32 fps = 3;
  uint32 bitrate_kbps = 4;
  string codec = 5;  // "h264", "vp8"
}

message StartCameraResponse {
  ResponseBase base = 1;
  string session_id = 2;
  
  // WebRTC 信令信息
  string sdp_offer = 3;
  repeated string ice_candidates = 4;
}

message StopCameraRequest {
  RequestBase base = 1;
  string session_id = 2;
}

message StopCameraResponse {
  ResponseBase base = 1;
}

// ==================== WebRTC 信令 ====================

// WebRTC 信令类型
enum WebRTCSignalType {
  WEBRTC_SIGNAL_TYPE_UNSPECIFIED = 0;
  WEBRTC_SIGNAL_TYPE_OFFER = 1;       // SDP Offer
  WEBRTC_SIGNAL_TYPE_ANSWER = 2;      // SDP Answer
  WEBRTC_SIGNAL_TYPE_ICE_CANDIDATE = 3;  // ICE Candidate
  WEBRTC_SIGNAL_TYPE_ICE_DONE = 4;    // ICE gathering done
  WEBRTC_SIGNAL_TYPE_HANGUP = 5;      // 结束通话
}

// WebRTC 信令消息
message WebRTCSignal {
  string session_id = 1;              // 会话唯一标识
  WebRTCSignalType type = 2;          // 信令类型
  
  // 信令数据（根据 type 使用不同字段）
  string sdp = 3;                     // SDP (Offer/Answer)
  string ice_candidate = 4;           // ICE candidate JSON
  string ice_mid = 5;                 // ICE media stream ID
  int32 ice_mline_index = 6;          // ICE m-line index
  
  // 会话配置（仅在 Offer 时使用）
  WebRTCSessionConfig config = 7;
}

// WebRTC 会话配置
message WebRTCSessionConfig {
  bool video_enabled = 1;             // 启用视频
  bool audio_enabled = 2;             // 启用音频
  string camera_id = 3;               // 摄像头 ID ("front", "rear", "depth")
  VideoProfile video_profile = 4;     // 视频配置
  AudioProfile audio_profile = 5;     // 音频配置
}

// 音频配置
message AudioProfile {
  uint32 sample_rate = 1;             // 采样率 (48000)
  uint32 channels = 2;                // 通道数 (1=mono, 2=stereo)
  string codec = 3;                   // 编码器 ("opus")
  uint32 bitrate_kbps = 4;            // 比特率
}
