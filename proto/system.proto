// system.proto
// SystemService - 会话管理、鉴权、心跳、能力查询
// 版本: 1.0.0

syntax = "proto3";

package robot.v1;

import "common.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";

// SystemService - 会话生命周期与能力查询
service SystemService {
  rpc Login(LoginRequest) returns (LoginResponse);
  rpc Logout(LogoutRequest) returns (LogoutResponse);
  rpc Heartbeat(HeartbeatRequest) returns (HeartbeatResponse);
  rpc GetRobotInfo(google.protobuf.Empty) returns (RobotInfoResponse);
  rpc GetCapabilities(google.protobuf.Empty) returns (CapabilitiesResponse);
  
  // 重定位（加载地图并设置初始位姿）
  rpc Relocalize(RelocalizeRequest) returns (RelocalizeResponse);
  
  // 保存地图
  rpc SaveMap(SaveMapRequest) returns (SaveMapResponse);
  
  // 地图管理
  rpc ListMaps(ListMapsRequest) returns (ListMapsResponse);
  rpc DeleteMap(DeleteMapRequest) returns (DeleteMapResponse);
  rpc RenameMap(RenameMapRequest) returns (RenameMapResponse);
}

// ==================== 登录 ====================

message LoginRequest {
  RequestBase base = 1;
  string username = 2;
  string password = 3;
  UserRole requested_role = 4;
}

message LoginResponse {
  ResponseBase base = 1;
  string session_token = 2;
  UserRole granted_role = 3;
  google.protobuf.Duration session_ttl = 4;
}

message LogoutRequest {
  RequestBase base = 1;
  bool release_lease = 2;
}

message LogoutResponse {
  ResponseBase base = 1;
}

// ==================== 心跳 ====================

message HeartbeatRequest {
  google.protobuf.Timestamp client_timestamp = 1;
  ConnectionQuality client_quality = 2;
}

message HeartbeatResponse {
  google.protobuf.Timestamp server_timestamp = 1;
  ConnectionQuality server_quality = 2;
  int32 active_sessions = 3;
  google.protobuf.Duration lease_ttl = 4;
}

// ==================== 信息查询 ====================

message RobotInfoResponse {
  ResponseBase base = 1;
  string robot_id = 2;
  string display_name = 3;
  string firmware_version = 4;
  string software_version = 5;
}

message CapabilitiesResponse {
  ResponseBase base = 1;
  repeated string supported_resources = 2;
  repeated TaskType supported_tasks = 3;
  bool teleop_supported = 4;
  bool mapping_supported = 5;
}

// ==================== 重定位 ====================

message RelocalizeRequest {
  RequestBase base = 1;
  string pcd_path = 2;     // PCD 地图文件路径
  double x = 3;            // 初始位置 X (m)
  double y = 4;            // 初始位置 Y (m)
  double z = 5;            // 初始位置 Z (m)
  double yaw = 6;          // 偏航角 (rad)
  double pitch = 7;        // 俯仰角 (rad)
  double roll = 8;         // 横滚角 (rad)
}

message RelocalizeResponse {
  ResponseBase base = 1;
  bool success = 2;
  string message = 3;
}

// ==================== 保存地图 ====================

message SaveMapRequest {
  RequestBase base = 1;
  string file_path = 2;    // 保存路径
  bool save_patches = 3;   // 是否保存子图
}

message SaveMapResponse {
  ResponseBase base = 1;
  bool success = 2;
  string message = 3;
}

// ==================== 地图管理 ====================

message MapInfo {
  string name = 1;               // 文件名（不含路径）
  string path = 2;               // 完整路径
  int64 size_bytes = 3;          // 文件大小
  string created_at = 4;         // ISO 8601 创建时间
  string modified_at = 5;        // ISO 8601 修改时间
  int32 point_count = 6;         // 点云数量（PCD 文件）
}

message ListMapsRequest {
  RequestBase base = 1;
  string directory = 2;          // 搜索目录，默认 "/maps"
}

message ListMapsResponse {
  ResponseBase base = 1;
  repeated MapInfo maps = 2;
}

message DeleteMapRequest {
  RequestBase base = 1;
  string path = 2;               // 要删除的地图路径
}

message DeleteMapResponse {
  ResponseBase base = 1;
  bool success = 2;
  string message = 3;
}

message RenameMapRequest {
  RequestBase base = 1;
  string old_path = 2;           // 原路径
  string new_name = 3;           // 新文件名（不含路径）
}

message RenameMapResponse {
  ResponseBase base = 1;
  bool success = 2;
  string new_path = 3;           // 重命名后的完整路径
  string message = 4;
}
