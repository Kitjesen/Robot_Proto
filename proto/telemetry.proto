// telemetry.proto
// TelemetryService - 状态流（fast/slow/event）
// 版本: 1.0.0

syntax = "proto3";

package robot.v1;

import "common.proto";

// TelemetryService - 三条状态流
service TelemetryService {
  // 快速状态流（20-60Hz）- 姿态、速度、IMU
  rpc StreamFastState(FastStateRequest) returns (stream FastState);
  
  // 慢速状态流（1-2Hz）- 电量、温度、模式、任务摘要
  rpc StreamSlowState(SlowStateRequest) returns (stream SlowState);
  
  // 事件流（事件驱动，带回放）
  rpc StreamEvents(EventStreamRequest) returns (stream Event);
  
  // 确认事件（客户端已查看）
  rpc AckEvent(AckEventRequest) returns (AckEventResponse);
}

// ==================== 快速状态 ====================

message FastStateRequest {
  // 期望频率（Hz），服务端尽力满足
  double desired_hz = 1;
}

message FastState {
  Header header = 1;
  
  // 位姿（odom 坐标系）
  Pose pose = 2;
  
  // 速度（body 坐标系）
  Twist velocity = 3;
  
  // IMU 原始数据
  Vector3 linear_acceleration = 4;  // m/s^2
  Vector3 angular_velocity = 5;     // rad/s
  
  // 姿态角（roll/pitch/yaw，度）
  Vector3 rpy_deg = 6;
  
  // TF 状态
  bool tf_ok = 7;

  // 关节角度 (rad)
  // 16 个值: 每条腿 4 个 (hip, thigh, calf, foot)
  // 顺序: FR(0-3), FL(4-7), RR(8-11), RL(12-15)
  // 12-DOF 机器人 foot 值为 0
  repeated float joint_angles = 8;
}

// ==================== 慢速状态 ====================

message SlowStateRequest {}

message SlowState {
  Header header = 1;
  
  // 当前模式
  string current_mode = 2;
  
  // 任务摘要
  Task active_task = 3;
  
  // 系统资源
  SystemResource resources = 4;
  
  // 网络质量
  ConnectionQuality network = 5;
  
  // 话题频率（用于诊断）
  TopicRates topic_rates = 6;
  
  // 导航状态（扩展）
  NavigationStatus navigation = 7;

  // 健康状态（综合诊断）
  HealthStatus health = 8;

  // 围栏状态
  GeofenceStatus geofence = 9;
}

message SystemResource {
  double cpu_percent = 1;
  double mem_percent = 2;
  double cpu_temp = 3;
  double battery_percent = 4;  // 0-100
  double battery_voltage = 5;
}

message TopicRates {
  float odom_hz = 1;
  float terrain_map_hz = 2;
  float path_hz = 3;
  float lidar_hz = 4;
  float cmd_vel_hz = 5;
  float global_path_hz = 6;
}

// ==================== 健康状态 ====================

message HealthStatus {
  // 综合健康等级: "OK", "DEGRADED", "CRITICAL", "FAULT"
  string overall_level = 1;

  // 各子系统状态
  repeated SubsystemHealth subsystems = 2;

  // 定位质量 (ICP fitness score, 越低越好, -1=不可用)
  float localization_score = 3;
}

message SubsystemHealth {
  string name = 1;             // 子系统名 (slam, terrain_analysis, local_planner, tf_chain, localization)
  string level = 2;            // "OK", "DEGRADED", "CRITICAL", "FAULT"
  string message = 3;          // 人类可读描述
  double expected_hz = 4;      // 期望频率 (0=非频率指标)
  double actual_hz = 5;        // 实际频率
}

// ==================== 围栏状态 ====================

message GeofenceStatus {
  // 围栏状态: "NO_FENCE", "SAFE", "WARNING", "VIOLATION"
  string state = 1;

  // 是否已设置围栏
  bool has_fence = 2;

  // 到最近围栏边的距离 (m), 负值表示越界
  double margin_distance = 3;
}

// ==================== 导航状态扩展 ====================

message NavigationStatus {
  // 全局规划器状态 ("IDLE", "PLANNING", "SUCCESS", "FAILED", "ERROR")
  string global_planner_status = 1;
  
  // 当前目标航点 (odom 坐标系)
  Vector3 current_waypoint = 2;
  bool has_waypoint = 3;
  
  // 全局路径长度 (m)
  float global_path_length = 4;
  bool has_global_path = 5;
  
  // 定位状态
  bool localization_valid = 6;
  
  // 减速级别 (0=正常, 1-3=减速)
  int32 slow_down_level = 7;
}

// ==================== 事件流 ====================

message EventStreamRequest {
  // 客户端已知的最后事件 ID
  // 服务端会补发 > last_event_id 的所有事件（回放）
  string last_event_id = 1;
  
  // 过滤条件
  repeated EventType filter_types = 2;
  EventSeverity min_severity = 3;
}

message AckEventRequest {
  RequestBase base = 1;
  string event_id = 2;
}

message AckEventResponse {
  ResponseBase base = 1;
}
